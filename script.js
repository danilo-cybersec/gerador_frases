const imagens = {
  trabalho: [
    'imagens/trabalho/trabalho1.jpg',
    'imagens/trabalho/trabalho2.jpg',
    'imagens/trabalho/trabalho3.jpg',
    'imagens/trabalho/trabalho4.jpg',
    'imagens/trabalho/trabalho5.jpg',
    'imagens/trabalho/trabalho6.jpg',
    'imagens/trabalho/trabalho7.jpg',
    'imagens/trabalho/trabalho8.jpg',
    'imagens/trabalho/trabalho9.jpg',
    'imagens/trabalho/trabalho10.jpg',
    'imagens/trabalho/trabalho11.jpg',
    'imagens/trabalho/trabalho12.jpg',
    'imagens/trabalho/trabalho13.jpg',
    'imagens/trabalho/trabalho14.jpg',
    'imagens/trabalho/trabalho15.jpg',
    'imagens/trabalho/trabalho16.jpg',
    'imagens/trabalho/trabalho17.jpg',
    'imagens/trabalho/trabalho18.jpg',
    'imagens/trabalho/trabalho19.jpg'
  ],
  amor: [
    'imagens/amor/amor1.png',
    'imagens/amor/amor2.jpg',
    'imagens/amor/amor3.jpg',
    'imagens/amor/amor4.jpg',
    'imagens/amor/amor5.jpg',
    'imagens/amor/amor6.jpg',
    'imagens/amor/amor7.jpg',
    'imagens/amor/amor8.jpg',
    'imagens/amor/amor9.jpg',
    'imagens/amor/amor10.jpg',
    'imagens/amor/amor11.jpg',
    'imagens/amor/amor12.jpg',
    'imagens/amor/amor13.jpg',
    'imagens/amor/amor14.jpg',
    'imagens/amor/amor15.jpg',
    'imagens/amor/amor16.jpg',
    'imagens/amor/amor17.jpg',
    'imagens/amor/amor18.jpg',
    'imagens/amor/amor19.jpg',
    'imagens/amor/amor20.jpg'
  ],
  sucesso: [
    'imagens/sucesso_superacao/sucesso1.jpg',
    'imagens/sucesso_superacao/sucesso2.jpg',
    'imagens/sucesso_superacao/sucesso3.jpg',
    'imagens/sucesso_superacao/sucesso4.jpg',
    'imagens/sucesso_superacao/sucesso5.jpg',
    'imagens/sucesso_superacao/sucesso6.jpg',
    'imagens/sucesso_superacao/sucesso7.jpg',
    'imagens/sucesso_superacao/sucesso8.jpg',
    'imagens/sucesso_superacao/sucesso9.jpg',
    'imagens/sucesso_superacao/sucesso10.jpg',
    'imagens/sucesso_superacao/sucesso11.jpg',
    'imagens/sucesso_superacao/sucesso12.jpg',
    'imagens/sucesso_superacao/sucesso13.jpg',
    'imagens/sucesso_superacao/sucesso14.jpg',
    'imagens/sucesso_superacao/sucesso15.jpg',
    'imagens/sucesso_superacao/sucesso16.jpg',
    'imagens/sucesso_superacao/sucesso17.jpg',
    'imagens/sucesso_superacao/sucesso18.jpg',
    'imagens/sucesso_superacao/sucesso19.jpg',
    'imagens/sucesso_superacao/sucesso20.jpg',
    'imagens/sucesso_superacao/sucesso21.jpg',
    'imagens/sucesso_superacao/sucesso22.jpg',
    'imagens/sucesso_superacao/sucesso23.jpg',
    'imagens/sucesso_superacao/sucesso24.jpg'
  ],
  superacao: [
    'imagens/sucesso_superacao/sucesso1.jpg',
    'imagens/sucesso_superacao/sucesso2.jpg',
    'imagens/sucesso_superacao/sucesso3.jpg',
    'imagens/sucesso_superacao/sucesso4.jpg',
    'imagens/sucesso_superacao/sucesso5.jpg',
    'imagens/sucesso_superacao/sucesso6.jpg',
    'imagens/sucesso_superacao/sucesso7.jpg',
    'imagens/sucesso_superacao/sucesso8.jpg',
    'imagens/sucesso_superacao/sucesso9.jpg',
    'imagens/sucesso_superacao/sucesso10.jpg',
    'imagens/sucesso_superacao/sucesso11.jpg',
    'imagens/sucesso_superacao/sucesso13.jpg',
    'imagens/sucesso_superacao/sucesso14.jpg',
    'imagens/sucesso_superacao/sucesso15.jpg',
    'imagens/sucesso_superacao/sucesso16.jpg',
    'imagens/sucesso_superacao/sucesso17.jpg',
    'imagens/sucesso_superacao/sucesso18.jpg',
    'imagens/sucesso_superacao/sucesso19.jpg',
    'imagens/sucesso_superacao/sucesso20.jpg',
    'imagens/sucesso_superacao/sucesso21.jpg',
    'imagens/sucesso_superacao/sucesso22.jpg',
    'imagens/sucesso_superacao/sucesso23.jpg',
    'imagens/sucesso_superacao/sucesso24.jpg'
  ],
  autoconhecimento: [
    'imagens/autoconhecimento/autoconhecimento1.png',
    'imagens/autoconhecimento/autoconhecimento2.jpg',
    'imagens/autoconhecimento/autoconhecimento3.jpg',
    'imagens/autoconhecimento/autoconhecimento4.jpg',
    'imagens/autoconhecimento/autoconhecimento5.jpg',
    'imagens/autoconhecimento/autoconhecimento6.jpg',
    'imagens/autoconhecimento/autoconhecimento7.jpg',
    'imagens/autoconhecimento/autoconhecimento8.jpg',
    'imagens/autoconhecimento/autoconhecimento9.jpg',
    'imagens/autoconhecimento/autoconhecimento10.jpg',
    'imagens/autoconhecimento/autoconhecimento11.jpg',
    'imagens/autoconhecimento/autoconhecimento12.jpg',
    'imagens/autoconhecimento/autoconhecimento13.jpg',
    'imagens/autoconhecimento/autoconhecimento14.jpg',
    'imagens/autoconhecimento/autoconhecimento15.jpg',
    'imagens/autoconhecimento/autoconhecimento16.png',
    'imagens/autoconhecimento/autoconhecimento17.jpg'
  ],
  gratidao: [
    'imagens/gratidao/gratidao1.jpg',
    'imagens/gratidao/gratidao2.jpg',
    'imagens/gratidao/gratidao3.jpg',
    'imagens/gratidao/gratidao4.jpg',
    'imagens/gratidao/gratidao5.jpg',
    'imagens/gratidao/gratidao6.jpg',
    'imagens/gratidao/gratidao7.jpg',
    'imagens/gratidao/gratidao8.jpg',
    'imagens/gratidao/gratidao9.jpg',
    'imagens/gratidao/gratidao10.jpg',
    'imagens/gratidao/gratidao11.jpg',
    'imagens/gratidao/gratidao12.jpg',
    'imagens/gratidao/gratidao13.jpg',
    'imagens/gratidao/gratidao14.jpg',
    'imagens/gratidao/gratidao15.jpg',
    'imagens/gratidao/gratidao16.jpg',
    'imagens/gratidao/gratidao17.jpg'
  ],
  Deus: [
    'imagens/Deus/Deus1.jpg',
    'imagens/Deus/Deus2.jpg',
    'imagens/Deus/Deus3.jpg',
    'imagens/Deus/Deus4.jpg',
    'imagens/Deus/Deus5.jpg',
    'imagens/Deus/Deus6.jpg',
    'imagens/Deus/Deus7.jpg',
    'imagens/Deus/Deus8.jpg',
    'imagens/Deus/Deus9.jpg',
    'imagens/Deus/Deus10.jpg',
    'imagens/Deus/Deus11.jpg',
    'imagens/Deus/Deus12.jpg',
    'imagens/Deus/Deus13.jpg',
    'imagens/Deus/Deus14.jpg',
    'imagens/Deus/Deus15.jpg',
    'imagens/Deus/Deus16.jpg',
    'imagens/Deus/Deus17.jpg',
    'imagens/Deus/Deus18.jpg',
    'imagens/Deus/Deus19.jpg'
  ]
};

const categoriaSelect = document.getElementById('categoria');
const gerarFraseBtn = document.getElementById('gerarFrase');
const fraseContainer = document.getElementById('fraseContainer');
const fraseTexto = document.getElementById('fraseTexto');
const shareButtons = document.getElementById('shareButtons');
const shareXBtn = document.getElementById('shareX');
const shareFacebookBtn = document.getElementById('shareFacebook');
const shareInstagramBtn = document.getElementById('shareInstagram');
const shareLinkedInBtn = document.getElementById('shareLinkedIn');
const contadorElement = document.getElementById('contador');

// Função para buscar o número de visitantes únicos via Google Analytics Data API
async function fetchVisitorCount() {
  const API_KEY = 'AIzaSyC43Mng3i8SXeoRWuK7me2o-Kpbu5ZnRvA'; // Substitua por sua chave de API do Google Cloud
  const PROPERTY_ID = '486666755'; // Substitua pelo ID da propriedade do Google Analytics (ex.: 'properties/123456789')

  try {
    const response = await fetch(
      `https://analyticsdata.googleapis.com/v1beta/${PROPERTY_ID}:runReport?key=${API_KEY}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          dateRanges: [{ startDate: '2025-01-01', endDate: 'today' }], // Período desde o início do ano até hoje
          metrics: [{ name: 'activeUsers' }], // Métrica para visitantes únicos
        }),
      }
    );
    const data = await response.json();
    if (data.rows && data.rows.length > 0) {
      const visitorCount = data.rows[0].metricValues[0].value;
      contadorElement.textContent = `Visitantes: ${visitorCount}`;
    } else {
      contadorElement.textContent = 'Visitantes: 0';
    }
  } catch (error) {
    console.error('Erro ao buscar o número de visitantes:', error);
    contadorElement.textContent = 'Visitantes: Erro';
  }
}

// Chama a função para buscar o número de visitantes quando a página carrega
document.addEventListener('DOMContentLoaded', () => {
  fetchVisitorCount();
});

function getRandomItem(array) {
  return array[Math.floor(Math.random() * array.length)];
}

function wrapText(ctx, text, maxWidth) {
  const words = text.split(' ');
  const lines = [];
  let currentLine = words[0];

  for (let i = 1; i < words.length; i++) {
    const word = words[i];
    const width = ctx.measureText(currentLine + ' ' + word).width;
    if (width < maxWidth) {
      currentLine += ' ' + word;
    } else {
      lines.push(currentLine);
      currentLine = word;
    }
  }
  lines.push(currentLine);
  return lines;
}

function generateShareImage(frase, imagem, includeIcons, width, height, callback) {
  const canvas = document.createElement('canvas');
  canvas.width = width; // Dimensões personalizadas
  canvas.height = height;
  const ctx = canvas.getContext('2d');

  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = imagem;
  img.onload = () => {
    // Ajustar a imagem de fundo para cobrir o canvas
    const imgAspect = img.width / img.height;
    const canvasAspect = canvas.width / canvas.height;
    let drawWidth, drawHeight, offsetX, offsetY;

    if (imgAspect > canvasAspect) {
      // Imagem mais larga que o canvas
      drawHeight = canvas.height;
      drawWidth = drawHeight * imgAspect;
      offsetX = (canvas.width - drawWidth) / 2;
      offsetY = 0;
    } else {
      // Imagem mais alta que o canvas
      drawWidth = canvas.width;
      drawHeight = drawWidth / imgAspect;
      offsetX = 0;
      offsetY = (canvas.height - drawHeight) / 2;
    }

    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);

    // Texto da frase
    ctx.fillStyle = 'white';
    ctx.font = `bold ${width === 1080 ? 48 : 40}px "Dancing Script"`; // Ajustar o tamanho da fonte para o Instagram
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
    ctx.shadowBlur = 6;
    ctx.shadowOffsetX = 3;
    ctx.shadowOffsetY = 3;

    const maxWidth = canvas.width - 240;
    const lines = wrapText(ctx, frase, maxWidth);
    const lineHeight = 50;
    const textHeight = lines.length * lineHeight;
    const startY = canvas.height - textHeight - 50; // Posiciona na parte inferior, 50px da borda

    lines.forEach((line, index) => {
      ctx.fillText(line, canvas.width / 2, startY + index * lineHeight);
    });

    if (!includeIcons) {
      // Se não incluir ícones, chama o callback imediatamente
      const dataUrl = canvas.toDataURL('image/png');
      callback(dataUrl);
      return;
    }

    // Desativa a sombra para os ícones
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    // Ícones das redes sociais (no canto inferior direito, acima do texto)
    const iconSize = 40;
    const iconSpacing = 10;
    const iconStartX = canvas.width - (iconSize * 4 + iconSpacing * 3) - 20; // 4 ícones, 3 espaços, margem de 20px
    const iconY = canvas.height - textHeight - 50 - iconSize - 20; // Acima do texto

    const icons = [
      'imagens/icons/x.png',
      'imagens/icons/facebook.png',
      'imagens/icons/instagram.png',
      'imagens/icons/linkedin.png'
    ];

    let loadedIcons = 0;
    const totalIcons = icons.length;

    if (totalIcons === 0) {
      const dataUrl = canvas.toDataURL('image/png');
      callback(dataUrl);
      return;
    }

    let currentX = iconStartX;
    icons.forEach((iconUrl) => {
      const icon = new Image();
      icon.crossOrigin = 'anonymous';
      icon.src = iconUrl;
      icon.onload = () => {
        ctx.drawImage(icon, currentX, iconY, iconSize, iconSize);
        currentX += iconSize + iconSpacing;
        loadedIcons++;
        if (loadedIcons === totalIcons) {
          const dataUrl = canvas.toDataURL('image/png');
          callback(dataUrl);
        }
      };
      icon.onerror = () => {
        console.error(`Erro ao carregar ícone: ${iconUrl}`);
        loadedIcons++;
        if (loadedIcons === totalIcons) {
          const dataUrl = canvas.toDataURL('image/png');
          callback(dataUrl);
        }
      };
    });
  };
  img.onerror = () => {
    console.error(`Erro ao carregar imagem de fundo: ${imagem}`);
    callback(null);
  };
}

function gerarFrase() {
  const categoria = categoriaSelect.value;
  console.log('Categoria selecionada:', categoria);
  const frasesCategoria = frases[categoria];
  const imagensCategoria = imagens[categoria];
  console.log('Frases:', frasesCategoria);
  console.log('Imagens:', imagensCategoria);

  if (!frasesCategoria || !imagensCategoria) {
    console.error('Categoria não encontrada:', categoria);
    fraseTexto.textContent = 'Erro: Categoria não encontrada.';
    return;
  }

  const frase = getRandomItem(frasesCategoria);
  const imagem = getRandomItem(imagensCategoria);
  console.log('Frase selecionada:', frase);
  console.log('Imagem selecionada:', imagem);

  fraseContainer.style.backgroundImage = `url(${imagem})`;
  fraseTexto.textContent = frase;

  shareButtons.style.display = 'flex';
  shareButtons.dataset.frase = frase;
  shareButtons.dataset.imagem = imagem;
}

function shareOnX() {
  const frase = shareButtons.dataset.frase;
  const imagem = shareButtons.dataset.imagem;
  generateShareImage(frase, imagem, false, 1280, 853, (dataUrl) => {
    if (!dataUrl) {
      alert('Erro ao gerar a imagem para compartilhamento.');
      return;
    }
    const text = encodeURIComponent(frase);
    const url = encodeURIComponent(window.location.href);
    const shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
    window.open(shareUrl, '_blank');
  });
}

function shareOnFacebook() {
  const frase = shareButtons.dataset.frase;
  const imagem = shareButtons.dataset.imagem;
  generateShareImage(frase, imagem, false, 1280, 853, (dataUrl) => {
    if (!dataUrl) {
      alert('Erro ao gerar a imagem para compartilhamento.');
      return;
    }
    const url = encodeURIComponent(window.location.href);
    const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}"e=${encodeURIComponent(frase)}`;
    window.open(shareUrl, '_blank');
  });
}

function shareOnInstagram() {
  const frase = shareButtons.dataset.frase;
  const imagem = shareButtons.dataset.imagem;
  generateShareImage(frase, imagem, false, 1080, 1080, (dataUrl) => {
    if (!dataUrl) {
      alert('Erro ao gerar a imagem para compartilhamento.');
      return;
    }
    try {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = 'frase-motivacional.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert('Imagem baixada! Abra o Instagram e publique a imagem manualmente.');
    } catch (error) {
      console.error('Erro ao baixar a imagem:', error);
      alert('Ocorreu um erro ao baixar a imagem. Verifique o console para mais detalhes.');
    }
  });
}

function shareOnLinkedIn() {
  const frase = shareButtons.dataset.frase;
  const imagem = shareButtons.dataset.imagem;
  generateShareImage(frase, imagem, false, 1280, 853, (dataUrl) => {
    if (!dataUrl) {
      alert('Erro ao gerar a imagem para compartilhamento.');
      return;
    }
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('Frase Motivacional');
    const summary = encodeURIComponent(frase);
    const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}&title=${title}&summary=${summary}`;
    window.open(shareUrl, '_blank');
  });
}

gerarFraseBtn.addEventListener('click', gerarFrase);
shareXBtn.addEventListener('click', shareOnX);
shareFacebookBtn.addEventListener('click', shareOnFacebook);
shareInstagramBtn.addEventListener('click', shareOnInstagram);
shareLinkedInBtn.addEventListener('click', shareOnLinkedIn);